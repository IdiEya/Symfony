{# templates/admin/user_management.html.twig #}
<!DOCTYPE html>
<html lang="en">

<head>
  <title>{% block title %}User Management | Mantis Admin{% endblock %}</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="User management dashboard">

  {% block css %}
  <link rel="icon" href="{{ asset('assets/back/dist/assets/images/favicon.svg') }}" type="image/x-icon">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="{{ asset('assets/back/dist/assets/fonts/tabler-icons.min.css') }}">
  <link rel="stylesheet" href="{{ asset('assets/back/dist/assets/fonts/feather.css') }}">
  <link rel="stylesheet" href="{{ asset('assets/back/dist/assets/css/style.css') }}">
  <link rel="stylesheet" href="{{ asset('assets/back/dist/assets/css/style-preset.css') }}">
  <style>
    .user-management-container {
      margin-left: 280px;
      padding: 20px;
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }

    .users-table th,
    .users-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1050;
    }

    .modal {
      background: white;
      width: 500px;
      margin: 100px auto;
      border-radius: 10px;
      padding: 20px;
      position: relative;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    .modal-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .cancel-btn {
      background: #ddd;
    }

    .save-btn {
      background: #4caf50;
      color: white;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-label {
      display: block;
      margin-bottom: 5px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 8px;
    }
  </style>
  {% endblock %}
</head>

<body>
  {% block body %}
  <div class="user-management-container">
    <h2>Gestion des Utilisateurs</h2>

    <div class="user-controls mb-3">
      <input type="text" placeholder="Rechercher..." class="form-control search-input">
    </div>

    <div class="table-responsive">
      <table class="users-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Prénom</th>
            <th>Mail</th>
            <th>Rôle</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>{{ user.nom }}</td>
            <td>{{ user.prenom }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.role }}</td>
            <td>
              <button class="edit-btn action-btn" onclick="openEditModal(
                '{{ user.id }}',
                '{{ user.role }}',
                '{{ user.note }}',
                '{{ user.prenom }}',
                '{{ user.nom }}',
                '{{ user.email }}',
                '{{ user.telephone }}',
                '{{ user.adresse }}',
                '{{ user.specialite }}'
              )">Modifier</button>
              <button class="delete-btn action-btn" onclick="openDeleteModal('{{ user.id }}')">Supprimer</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Modal Édition -->
    <div class="modal-backdrop" id="editModalBackdrop">
      <div class="modal">
        <div class="modal-body">
          <form id="editUserForm">
            <input type="hidden" id="userId">

            <div class="form-group">
              <label for="userRole" class="form-label">Role</label>
              <select id="userRole" class="form-select">
                <option value="admin">Admin</option>
                <option value="client">Client</option>
                <option value="mechanic">Mechanic</option>
              </select>
            </div>

            <div class="form-group">
              <label for="userRating" class="form-label">Note (1-5)</label>
              <input type="number" id="userRating" class="form-input" min="1" max="5">
            </div>

            <div class="form-group">
              <label for="userFirstName" class="form-label">Nom</label>
              <input type="text" id="userFirstName" class="form-input">
            </div>

            <div class="form-group">
              <label for="userLastName" class="form-label">Prénom</label>
              <input type="text" id="userLastName" class="form-input">
            </div>

            <div class="form-group">
              <label for="userEmail" class="form-label">Mail</label>
              <input type="email" id="userEmail" class="form-input">
            </div>

            <div class="form-group">
              <label for="userPhone" class="form-label">Téléphone</label>
              <input type="tel" id="userPhone" class="form-input">
            </div>

            <div class="form-group">
              <label for="userAddress" class="form-label">Adresse</label>
              <input type="text" id="userAddress" class="form-input">
            </div>

            <div class="form-group">
              <label for="userSpecialty" class="form-label">Spécialité</label>
              <input type="text" id="userSpecialty" class="form-input">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel-btn" onclick="closeModal('editModalBackdrop')">Annuler</button>
          <button class="modal-btn save-btn" onclick="saveUserChanges()">Enregistrer</button>
        </div>
      </div>
    </div>

    <!-- Modal Suppression -->
    <div class="modal-backdrop" id="deleteModalBackdrop">
      <div class="modal">
        <div class="modal-body">
          <p>Confirmer la suppression de cet utilisateur ?</p>
          <input type="hidden" id="deleteUserId">
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel-btn" onclick="closeModal('deleteModalBackdrop')">Annuler</button>
          <button class="modal-btn save-btn">Supprimer</button>
        </div>
      </div>
    </div>
  </div>
  {% endblock %}

  {% block js %}
  <script>
    const csrfToken = '{{ csrf_token("user_edit") }}'; // Assure que le token est généré côté Symfony

    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function openEditModal(id, role, note, prenom, nom, email, telephone, adresse, specialite) {
      document.getElementById('userId').value = id;
      document.getElementById('userRole').value = role;
      document.getElementById('userRating').value = note;
      document.getElementById('userFirstName').value = nom;
      document.getElementById('userLastName').value = prenom;
      document.getElementById('userEmail').value = email;
      document.getElementById('userPhone').value = telephone;
      document.getElementById('userAddress').value = adresse;
      document.getElementById('userSpecialty').value = specialite;

      openModal('editModalBackdrop');
    }

    function openDeleteModal(id) {
      document.getElementById('deleteUserId').value = id;
      openModal('deleteModalBackdrop');
    }

    async function saveUserChanges() {
      const userId = document.getElementById('userId').value;
      const formData = new FormData(document.getElementById('editUserForm'));

      try {
        const response = await fetch(`/admin/users/${userId}/edit`, {
          method: 'POST',
          body: formData,
          headers: { 'X-CSRF-Token': csrfToken }
        });

        if (response.ok) {
          location.reload();
        } else {
          alert("Erreur lors de la mise à jour de l'utilisateur.");
        }
      } catch (error) {
        console.error(error);
      }
    }

    document.querySelector('.search-input').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      document.querySelectorAll('.users-table tbody tr').forEach(row => {
        const rowText = row.textContent.toLowerCase();
        row.style.display = rowText.includes(searchTerm) ? '' : 'none';
      });
    });
  </script>
  {% endblock %}
</body>
</html>
